<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Rails 微信小程序支付 - 夕枫主&#39;s blog
    
  </title>

  <meta name="description" content="Rails 微信小程序支付">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="xifengzhu.github.com/rails/2017/07/08/rails-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%94%AF%E4%BB%98.html">
  <link rel="alternate" type="application/rss+xml" title="夕枫主&#39;s blog" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="/">夕枫主&#39;s blog</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fa fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/posts">Posts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/about">About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->

<header class="masthead" style="background-image: url('/assets/images/bg-post.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Rails 微信小程序支付</h1>
            
            <span class="meta">
              July 08, 2017 &middot; <span class="reading-time" title="Estimated read time">
  
   3 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <p>Rails 微信小程序支付</p>

<h3 id="prepare">Prepare</h3>
<ol>
  <li>
    <p>在公众平台注册一个小程序账号 <a href="https://mp.weixin.qq.com/cgi-bin/registermidpage?action=index&amp;lang=zh_CN">点击入口</a>
<img src="/assets/images/微信公众平台.png" alt="微信公众平台.png" /></p>
  </li>
  <li>
    <p>申请微信支付
<img src="/assets/images/申请支付.jpg" alt="申请支付.jpg" /></p>
  </li>
  <li>
    <p>配置商户信息
申请微信支付成功后，登陆商户平台(pay.weixin.qq.com)进入账户中心，设置微信商户的API Key与下载证书</p>
  </li>
  <li>
    <p>配置Https服务器
可以参考：<a href="http://xifengzhu.github.io/%E9%83%A8%E7%BD%B2/2017/05/09/%E4%BD%BF%E7%94%A8-Let-s-Encrypt-%E5%8A%A0%E5%AF%86(HTTPS)%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99.html">使用 Let’s Encrypt 加密(HTTPS)你的网站</a></p>
  </li>
</ol>

<h3 id="rails-服务端">Rails 服务端</h3>

<h4 id="installation-gem">Installation gem</h4>

<p>Add this line to your Gemfile:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'wx_pay'</span>
</code></pre></div></div>

<p>And then execute:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">install</span>
</code></pre></div></div>

<h4 id="config">Config</h4>

<p>Create config/initializers/wx_pay.rb and put following configurations into it.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># required</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">appid</span> <span class="o">=</span> <span class="s1">'YOUR_APPID'</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">key</span> <span class="o">=</span> <span class="s1">'YOUR_KEY'</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">mch_id</span> <span class="o">=</span> <span class="s1">'YOUR_MCH_ID'</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">debug_mode</span> <span class="o">=</span> <span class="kp">true</span> <span class="c1"># default is `true`</span>

<span class="c1"># cert, see https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=4_3</span>
<span class="c1"># using PCKS12</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">set_apiclient_by_pkcs12</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">pkcs12_filepath</span><span class="p">),</span> <span class="n">pass</span><span class="p">)</span>

<span class="c1"># if you want to use `generate_authorize_req` and `authenticate`</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">appsecret</span> <span class="o">=</span> <span class="s1">'YOUR_SECRET'</span>

<span class="c1"># optional - configurations for RestClient timeout, etc.</span>
<span class="no">WxPay</span><span class="p">.</span><span class="nf">extra_rest_client_options</span> <span class="o">=</span> <span class="p">{</span><span class="ss">timeout: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">open_timeout: </span><span class="mi">3</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="request-payment-for-miniapp">Request payment for miniapp</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># =&gt; {</span>
  <span class="c1">#    :appId=&gt;"wx6743cf23566a7991",</span>
  <span class="c1">#    :package=&gt;"prepay_id=wx20170703182440e40cd68a2e0757840067",</span>
  <span class="c1">#    :nonceStr=&gt;"dpKt531nHFruKbfu",</span>
  <span class="c1">#    :timeStamp=&gt;"1499077480",</span>
  <span class="c1">#    :signType=&gt;"MD5",</span>
  <span class="c1">#    :paySign=&gt;"183385DC3B435FF2164FB0C445DAACCD"</span>
  <span class="c1">#  }</span>
  <span class="k">def</span> <span class="nf">request_payment</span>
    <span class="n">unifiedorder</span> <span class="o">=</span> <span class="no">WxPay</span><span class="o">::</span><span class="no">Service</span><span class="p">.</span><span class="nf">invoke_unifiedorder</span> <span class="n">unifiedorder_params</span>
    <span class="n">js_payment_params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">prepayid: </span><span class="n">unifiedorder</span><span class="p">[</span><span class="ss">:raw</span><span class="p">][</span><span class="s2">"xml"</span><span class="p">][</span><span class="s2">"prepay_id"</span><span class="p">],</span>
      <span class="ss">noncestr: </span><span class="n">unifiedorder</span><span class="p">[</span><span class="ss">:raw</span><span class="p">][</span><span class="s2">"xml"</span><span class="p">][</span><span class="s2">"nonce_str"</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">WxPay</span><span class="o">::</span><span class="no">Service</span><span class="p">.</span><span class="nf">generate_js_pay_req</span> <span class="n">js_payment_params</span>
    <span class="n">result</span>
  <span class="k">end</span>

  <span class="c1"># official document for detailed request params and return fields</span>
  <span class="c1"># https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1</span>
  <span class="k">def</span> <span class="nf">unifiedorder_params</span>
    <span class="p">{</span>
      <span class="ss">body: </span><span class="s1">'商品订单支付'</span><span class="p">,</span>
      <span class="ss">out_trade_no: </span><span class="s1">'test003'</span><span class="p">,</span>
      <span class="ss">total_fee: </span><span class="mi">1</span><span class="p">,</span>
      <span class="ss">spbill_create_ip: </span><span class="s1">'127.0.0.1'</span><span class="p">,</span>
      <span class="ss">notify_url: </span><span class="s1">'https://youdomain/notify'</span><span class="p">,</span>
      <span class="ss">trade_type: </span><span class="s1">'JSAPI'</span><span class="p">,</span>
      <span class="ss">openid: </span><span class="s1">'OPENID'</span>
    <span class="p">}</span>
  <span class="k">end</span>
</code></pre></div></div>

<h3 id="wechat-nimiapp">Wechat nimiapp</h3>

<p>调用服务端的接口获取到必要的参数</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">:package=&gt;</span><span class="s2">"prepay_id=wx20170703182440e40cd68a2e0757840067"</span><span class="p">,</span><span class="w">
  </span><span class="err">:nonceStr=&gt;</span><span class="s2">"dpKt531nHFruKbfu"</span><span class="p">,</span><span class="w">
  </span><span class="err">:timeStamp=&gt;</span><span class="s2">"1499077480"</span><span class="p">,</span><span class="w">
  </span><span class="err">:signType=&gt;</span><span class="s2">"MD5"</span><span class="p">,</span><span class="w">
  </span><span class="err">:paySign=&gt;</span><span class="s2">"183385DC3B435FF2164FB0C445DAACCD"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>将上述服务端返回对应到小程序的参数中去:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">wx</span><span class="p">.</span><span class="nx">requestPayment</span><span class="p">({</span>
  <span class="dl">'</span><span class="s1">timeStamp</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1499077480</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">nonceStr</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dpKt531nHFruKbfu</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">package</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">prepay_id=wx20170703182440e40cd68a2e0757840067</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">signType</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">MD5</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">paySign</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">183385DC3B435FF2164FB0C445DAACCD</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">success</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">wx</span><span class="p">.</span><span class="nx">showToast</span><span class="p">({</span>
      <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">支付成功</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">icon</span><span class="p">:</span> <span class="dl">'</span><span class="s1">success</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">duration</span><span class="p">:</span> <span class="mi">2000</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="dl">'</span><span class="s1">fail</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">fail</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">支付失败</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

</code></pre></div></div>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/rails/2017/06/28/rails-grape-%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90jwt%E9%AA%8C%E8%AF%81.html" data-toggle="tooltip" data-placement="top" title="Rails grape 项目集成JWT验证">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2017/08/26/unicorn-auto-start-after-server-boot.html" data-toggle="tooltip" data-placement="top" title="Unicorn auto start after server boot">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>

<style>
    img {
        max-width: -webkit-fill-available;
    }
</style>

  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:xifengzhu520@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/xifengzhu">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/xifengzhu">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; xifengzhu 2024</p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



</body>

</html>