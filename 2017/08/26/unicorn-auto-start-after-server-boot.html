<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Unicorn auto start after server boot - 夕枫主&#39;s blog
    
  </title>

  <meta name="description" content="Running Unicorn as a Service">

  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="xifengzhu.github.com/2017/08/26/unicorn-auto-start-after-server-boot.html">
  <link rel="alternate" type="application/rss+xml" title="夕枫主&#39;s blog" href="/feed.xml">

</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="/">夕枫主&#39;s blog</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fa fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/posts">Posts</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/about">About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->

<header class="masthead" style="background-image: url('/assets/images/bg-post.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Unicorn auto start after server boot</h1>
            
            <span class="meta">
              August 26, 2017 &middot; <span class="reading-time" title="Estimated read time">
  
   8 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <h3 id="running-unicorn-as-a-service">Running Unicorn as a Service</h3>

<p>Add ${project_name}_unicorn file with follow command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/init.d/${project_name}_unicorn
</code></pre></div></div>

<p>paste follow text:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c"># File: /etc/init.d/${project_name}_unicorn</span>

<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          unicorn</span>
<span class="c"># Required-Start:    $local_fs $remote_fs $network $syslog</span>
<span class="c"># Required-Stop:     $local_fs $remote_fs $network $syslog</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: starts the unicorn web server</span>
<span class="c"># Description:       starts unicorn</span>
<span class="c">### END INIT INFO</span>

<span class="c"># Feel free to change any of the following variables for your app:</span>

<span class="c"># ubuntu is the default user on Amazon's EC2 Ubuntu instances.</span>
<span class="nv">USER</span><span class="o">=</span>deployer
<span class="c"># Replace [PATH_TO_RAILS_ROOT_FOLDER] with your application's path. I prefer</span>
<span class="c"># /srv/app-name to /var/www. The /srv folder is specified as the server's</span>
<span class="c"># "service data" folder, where services are located. The /var directory,</span>
<span class="c"># however, is dedicated to variable data that changes rapidly, such as logs.</span>
<span class="c"># Reference https://help.ubuntu.com/community/LinuxFilesystemTreeOverview for</span>
<span class="c"># more information.</span>
<span class="nv">APP_ROOT</span><span class="o">=</span><span class="s2">"/var/www/</span><span class="k">${</span><span class="nv">project_name</span><span class="k">}</span><span class="s2">/current"</span>
<span class="c"># Set the environment. This can be changed to staging or development for staging</span>
<span class="c"># servers.</span>
<span class="nv">RAILS_ENV</span><span class="o">=</span>production
<span class="c"># This should match the pid setting in $APP_ROOT/config/unicorn.rb.</span>
<span class="nv">PID</span><span class="o">=</span><span class="nv">$APP_ROOT</span>/tmp/pids/unicorn.pid
<span class="c"># A simple description for service output.</span>
<span class="nv">DESC</span><span class="o">=</span><span class="s2">"Unicorn app - </span><span class="nv">$RAILS_ENV</span><span class="s2">"</span>
<span class="c"># If you're using rbenv, you may need to use the following setup to get things</span>
<span class="c"># Unicorn can be run using `bundle exec unicorn` or `bin/unicorn`.</span>
<span class="nv">UNICORN</span><span class="o">=</span><span class="s2">"bin/bundle exec unicorn"</span>
<span class="c"># Execute the unicorn executable as a daemon, with the appropriate configuration</span>
<span class="c"># and in the appropriate environment.</span>
<span class="nv">UNICORN_OPTS</span><span class="o">=</span><span class="s2">"-c </span><span class="nv">$APP_ROOT</span><span class="s2">/config/unicorn/</span><span class="nv">$RAILS_ENV</span><span class="s2">.rb -E </span><span class="nv">$RAILS_ENV</span><span class="s2"> -D"</span>
<span class="nv">CMD</span><span class="o">=</span><span class="s2">"cd </span><span class="nv">$APP_ROOT</span><span class="s2"> &amp;&amp; </span><span class="nv">$UNICORN</span><span class="s2"> </span><span class="nv">$UNICORN_OPTS</span><span class="s2">"</span>
<span class="c"># Give your upgrade action a timeout of 60 seconds.</span>
<span class="nv">TIMEOUT</span><span class="o">=</span>60

<span class="c"># Store the action that we should take from the service command's first</span>
<span class="c"># argument (e.g. start, stop, upgrade).</span>
<span class="nv">action</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>

<span class="c"># Make sure the script exits if any variables are unset. This is short for</span>
<span class="c"># set -o nounset.</span>
<span class="nb">set</span> <span class="nt">-u</span>

<span class="c"># Set the location of the old pid. The old pid is the process that is getting</span>
<span class="c"># replaced.</span>
<span class="nv">old_pid</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PID</span><span class="s2">.oldbin"</span>

<span class="c"># Make sure the APP_ROOT is actually a folder that exists. An error message from</span>
<span class="c"># the cd command will be displayed if it fails.</span>
<span class="nb">cd</span> <span class="nv">$APP_ROOT</span> <span class="o">||</span> <span class="nb">exit </span>1

<span class="c"># A function to send a signal to the current unicorn master process.</span>
sig <span class="o">()</span> <span class="o">{</span>
  <span class="nb">test</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PID</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -<span class="nv">$1</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$PID</span><span class="sb">`</span>
<span class="o">}</span>

<span class="c"># Send a signal to the old process.</span>
oldsig <span class="o">()</span> <span class="o">{</span>
  <span class="nb">test</span> <span class="nt">-s</span> <span class="nv">$old_pid</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -<span class="nv">$1</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$old_pid</span><span class="sb">`</span>
<span class="o">}</span>

<span class="c"># A switch for handling the possible actions to take on the unicorn process.</span>
<span class="k">case</span> <span class="nv">$action</span> <span class="k">in</span>
  <span class="c"># Start the process by testing if it's there (sig 0), failing if it is,</span>
  <span class="c"># otherwise running the command as specified above.</span>
  start<span class="p">)</span>
    sig 0 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"</span><span class="nv">$DESC</span><span class="s2"> is already running"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    su - <span class="nv">$USER</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2">"</span>
    <span class="p">;;</span>

  <span class="c"># Graceful shutdown. Send QUIT signal to the process. Requests will be</span>
  <span class="c"># completed before the processes are terminated.</span>
  stop<span class="p">)</span>
    sig QUIT <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Stopping </span><span class="nv">$DESC</span><span class="s2">"</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Not running"</span>
    <span class="p">;;</span>

  <span class="c"># Quick shutdown - kills all workers immediately.</span>
  force-stop<span class="p">)</span>
    sig TERM <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Force-stopping </span><span class="nv">$DESC</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Not running"</span>
    <span class="p">;;</span>

  <span class="c"># Graceful shutdown and then start.</span>
  restart<span class="p">)</span>
    sig QUIT <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Restarting </span><span class="nv">$DESC</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">sleep </span>2 <span class="se">\</span>
      <span class="o">&amp;&amp;</span> su - <span class="nv">$USER</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Couldn't restart."</span>
    <span class="p">;;</span>

  <span class="c"># Reloads config file (unicorn.rb) and gracefully restarts all workers. This</span>
  <span class="c"># command won't pick up application code changes if you have `preload_app</span>
  <span class="c"># true` in your unicorn.rb config file.</span>
  reload<span class="p">)</span>
    sig HUP <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Reloading configuration for </span><span class="nv">$DESC</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Couldn't reload configuration."</span>
    <span class="p">;;</span>

  <span class="c"># Re-execute the running binary, then gracefully shutdown old process. This</span>
  <span class="c"># command allows you to have zero-downtime deployments. The application may</span>
  <span class="c"># spin for a minute, but at least the user doesn't get a 500 error page or</span>
  <span class="c"># the like. Unicorn interprets the USR2 signal as a request to start a new</span>
  <span class="c"># master process and phase out the old worker processes. If the upgrade fails</span>
  <span class="c"># for some reason, a new process is started.</span>
  upgrade<span class="p">)</span>
    <span class="k">if </span>sig USR2 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Upgrading </span><span class="nv">$DESC</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">sleep </span>10 <span class="se">\</span>
      <span class="o">&amp;&amp;</span> sig 0 <span class="o">&amp;&amp;</span> oldsig QUIT
    <span class="k">then
      </span><span class="nv">n</span><span class="o">=</span><span class="nv">$TIMEOUT</span>
      <span class="k">while </span><span class="nb">test</span> <span class="nt">-s</span> <span class="nv">$old_pid</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="nv">$n</span> <span class="nt">-ge</span> 0
      <span class="k">do
        </span><span class="nb">printf</span> <span class="s1">'.'</span> <span class="o">&amp;&amp;</span> <span class="nb">sleep </span>1 <span class="o">&amp;&amp;</span> <span class="nv">n</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$n</span> <span class="o">-</span> <span class="m">1</span> <span class="k">))</span>
      <span class="k">done
      </span><span class="nb">echo

      </span><span class="k">if </span><span class="nb">test</span> <span class="nv">$n</span> <span class="nt">-lt</span> 0 <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="nt">-s</span> <span class="nv">$old_pid</span>
      <span class="k">then
        </span><span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"</span><span class="nv">$old_pid</span><span class="s2"> still exists after </span><span class="nv">$TIMEOUT</span><span class="s2"> seconds"</span>
        <span class="nb">exit </span>1
      <span class="k">fi
      </span><span class="nb">exit </span>0
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Couldn't upgrade, starting 'su - </span><span class="nv">$USER</span><span class="s2"> -c </span><span class="se">\"</span><span class="nv">$CMD</span><span class="se">\"</span><span class="s2">' instead"</span>
    su - <span class="nv">$USER</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$CMD</span><span class="s2">"</span>
    <span class="p">;;</span>

  <span class="c"># A basic status checker. Just checks if the master process is responding to</span>
  <span class="c"># the `kill` command.</span>
  status<span class="p">)</span>
    sig 0 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"</span><span class="nv">$DESC</span><span class="s2"> is running."</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"</span><span class="nv">$DESC</span><span class="s2"> is not running."</span>
    <span class="p">;;</span>

  <span class="c"># Reopen all logs owned by the master and all workers.</span>
  reopen-logs<span class="p">)</span>
    sig USR1
    <span class="p">;;</span>

  <span class="c"># Any other action gets the usage message.</span>
  <span class="k">*</span><span class="p">)</span>
    <span class="c"># Usage</span>
    <span class="nb">echo</span> <span class="o">&gt;</span>&amp;2 <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;start|stop|restart|reload|upgrade|force-stop|reopen-logs&gt;"</span>
    <span class="nb">exit </span>1
    <span class="p">;;</span>
<span class="k">esac</span>

</code></pre></div></div>

<h3 id="make-sure-your-init-script-has-permission-to-be-executed">Make sure your init script has permission to be executed</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chmod +x /etc/init.d/${project_name}_unicorn
</code></pre></div></div>

<p>Now, you can run sudo service unicorn start to start your unicorn process</p>

<h3 id="add-your-script-to-the-default-runlevels">Add your script to the default runlevels</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo update-rc.d ${project_name}_unicorn defaults
</code></pre></div></div>

<p>So that your script will be executed by every reboot.</p>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/rails/2017/07/08/rails-%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%94%AF%E4%BB%98.html" data-toggle="tooltip" data-placement="top" title="Rails 微信小程序支付">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/2017/11/07/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E6%A4%8D%E5%85%A5%E6%8C%96%E7%9F%BF%E7%A8%8B%E5%BA%8F.html" data-toggle="tooltip" data-placement="top" title="服务器被植入挖矿程序">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>

<style>
    img {
        max-width: -webkit-fill-available;
    }
</style>

  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:xifengzhu520@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li class="list-inline-item">
            <a href="https://twitter.com/xifengzhu">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/xifengzhu">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; xifengzhu 2024</p>
      </div>
    </div>
  </div>
</footer>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/scripts.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



</body>

</html>